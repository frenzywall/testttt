<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Management Notice</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --success-color: #16a34a;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --background-color: #f0f5ff;
            --surface-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --highlight-color-start: rgba(37, 99, 235, 0.1);
            --highlight-color-end: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f5ff 0%, #e0eaff 100%);
            min-height: 100vh;
        }

      .nav-header {
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--glass-border);
    padding: 0.25rem 0.5rem;
    position: sticky;
    top: 0;
    z-index: 100;
    transition: all 0.3s ease;
    border-radius: 0 0 1rem 1rem;
    margin: 0 1rem;
}

.nav-header:hover {
    background: rgba(255, 255, 255, 0.25);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0;
}

.nav-logo {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary-color);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-left: 0;
    height: 100%;
}

.nav-logo img {
    height: 65px;
    width: auto;
    object-fit: contain;
    margin-left: 0;
    max-height: 100%;
}
.nav-links {
    display: flex;
    gap: 0.5rem;
}

.nav-link {
    color: var(--secondary-color);
    text-decoration: none;
    font-weight: 500;
    padding: 0.3rem 0.8rem;
    border-radius: 0.8rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
}

.nav-link:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    color: var(--primary-color);
}

.nav-link i {
    font-size: 1rem;
}

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            background: var(--surface-color);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        table {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        th {
            background: var(--primary-color);
            color: white !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            position: relative;
        }

        tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .info-content {
            background: var(--surface-color);
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .primary-btn {
            background-color: #007BFF;
            color: white;
        }
        .secondary-btn {
            background-color: #6c757d;
            color: white;
        }
        .success-btn {
            background-color: #28a745;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .editable {
            background-color: #fff3cd;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 8px;
        }
        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        pre {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .tz-toggle {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #f5f7ff);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(37, 99, 235, 0.1);
            transition: all 0.3s ease;
        }

        .tz-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .tz-toggle-label {
            font-weight: 500;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tz-toggle-label i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 30px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .time-conversion-warning {
            margin-left: auto;
            padding: 8px 15px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeeba;
            color: #856404;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .time-conversion-warning i {
            color: #f59e0b;
        }

        .disclaimer-marquee {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            margin-bottom: 20px;
            white-space: nowrap;
            overflow: hidden;
            border-radius: 4px;
            border: 1px solid #ffeeba;
        }

        .disclaimer-text {
            animation: marquee 20s linear infinite;
            display: inline-block;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .modal-content {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .email-viewer {
            display: grid;
            gap: 20px;
        }

        .email-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .email-meta {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .meta-label {
            font-weight: 600;
            color: #495057;
            min-width: 100px;
        }

        .email-body {
            background: white;
            padding: 25px;
            border-radius: 8px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .modal-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .tool-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            transform: translateY(-1px);
        }

        .time-conversion-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .download-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .policy-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #475569;
            color: white;
            font-size: 12px;
            cursor: help;
            margin-left: 8px;
            vertical-align: middle;
        }

        .policy-tooltip {
            visibility: hidden;
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.75rem;
            width: 200px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .policy-icon:hover + .policy-tooltip {
            visibility: visible;
            opacity: 1;
        }

        @media print {
            .policy-icon {
                display: none;
            }
        }

        table {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: white;
            transition: all 0.3s ease;
        }

        th, td {
            border: none;
            padding: 16px;
            text-align: left;
            position: relative;
            transition: all 0.2s;
        }

        th {
            background: var(--primary-color);
            color: white !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            position: relative;
        }

        tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        tbody tr {
            border-left: 4px solid transparent;
        }

        tr:nth-child(even) {
            background-color: #f9fafc;
        }

        tr:hover {
            background-color: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-color);
        }

        .editable {
            background-color: rgba(255, 243, 205, 0.2);
            border-bottom: 2px dashed var(--warning-color);
            padding: 16px;
            transition: all 0.3s ease;
        }

        .editable:focus {
            outline: none;
            background-color: #fff8e6;
            border-bottom: 2px solid var(--warning-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        @keyframes highlight {
            0% { background-color: var(--highlight-color-start); }
            100% { background-color: var(--highlight-color-end); }
        }

        .highlight-row {
            animation: highlight 1.5s ease;
        }

        .action-cell {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
        }

        .table-btn {
            padding: 8px;
            min-width: 32px;
            justify-content: center;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .edit-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .edit-btn:hover {
            background-color: #1e56cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.25);
        }

        .save-btn {
            background-color: var(--success-color);
            color: white;
        }

        .save-btn:hover {
            background-color: #15803d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(22, 163, 74, 0.25);
        }

        .delete-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .delete-btn:hover {
            background-color: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.25);
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .confirm-dialog.active .confirm-content {
            transform: translateY(0);
        }

        .confirm-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #1e293b;
        }

        .confirm-message {
            margin-bottom: 25px;
            color: #64748b;
        }

        .confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #cbd5e1;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .status-pill {
            display: inline-flex;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            align-items: center;
            gap: 4px;
        }

        .status-active {
            background-color: #dcfce7;
            color: #14532d;
        }

        .status-pending {
            background-color: #ffedd5;
            color: #7c2d12;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        th.sortable::after {
            content: '\f0dc';
            font-family: 'Font Awesome 5 Free';
            margin-left: 8px;
            opacity: 0.5;
        }
        
        th.sorted-asc::after {
            content: '\f0de';
            opacity: 1;
        }
        
        th.sorted-desc::after {
            content: '\f0dd';
            opacity: 1;
        }

        .impact-cell {
            text-align: center;
        }

        .impact-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .impact-low {
            background-color: #4ade80;
        }

        .impact-medium {
            background-color: #facc15;
        }

        .impact-high {
            background-color: #f43f5e;
        }

        @keyframes pulse {
            0% {
            transform: scale(0.8);
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.1);
            }
            70% {
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
            }
            100% {
            transform: scale(0.8);
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
            }
        }

        .impact-cell {
            text-align: center;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            position: relative;
            background: #f8f9fa;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .impact-option:not(:last-child) {
            border-right: 1px solid rgba(0,0,0,0.05);
        }

        .impact-option-low {
            color: #166534;
        }
        
        .impact-option-medium {
            color: #854d0e;
        }
        
        .impact-option-high {
            color: #9f1239;
        }

        .impact-option.selected {
            color: white;
        }

        .impact-option-low.selected {
            background-color: #4ade80;
        }

        .impact-option-medium.selected {
            background-color: #facc15;
        }

        .impact-option-high.selected {
            background-color: #f43f5e;
        }

        .impact-option .impact-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .impact-option-low .impact-dot {
            background-color: #4ade80;
        }

        .impact-option-medium .impact-dot {
            background-color: #facc15;
        }

        .impact-option-high .impact-dot {
            background-color: #f43f5e;
        }

        .impact-option:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .impact-option.selected:hover {
            filter: brightness(1.1);
        }

        .impact-cell {
            text-align: center;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            white-space: nowrap;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            width: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            pointer-events: none;
            transition: opacity 0.5s ease, width 0.5s ease, padding 0.5s ease;
        }

        .impact-option.selected {
            position: relative;
            opacity: 1;
            width: auto;
        }

        .impact-selector:hover {
            min-width: 240px;
            transition-delay: 0.15s;
        }

        .impact-selector:hover .impact-option {
            width: auto;
            padding: 8px 16px;
            opacity: 1;
            position: relative;
            pointer-events: auto;
            transition-delay: 0.15s;
        }

        @keyframes impactPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .impact-selector::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.2s ease;
        }
        
        .impact-selector:hover::after {
            opacity: 0;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            white-space: nowrap;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            width: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            pointer-events: none;
            transition: opacity 0.5s ease, width 0.5s ease, padding 0.5s ease;
        }

        .impact-option.selected {
            position: relative;
            opacity: 1;
            width: auto;
        }

        .impact-selector:hover {
            min-width: 240px;
            transition-delay: 0.15s;
        }

        .impact-selector:hover .impact-option {
            width: auto;
            padding: 8px 16px;
            opacity: 1;
            position: relative;
            pointer-events: auto;
            transition-delay: 0.15s;
        }

        @keyframes impactPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .impact-selector::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.2s ease;
        }
        
        .impact-selector:hover::after {
            opacity: 0;
        }

        .impact-cell {
            text-align: center;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            white-space: nowrap;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            width: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            pointer-events: none;
            transition: opacity 0.5s ease, width 0.5s ease, padding 0.5s ease;
        }

        .impact-option.selected {
            position: relative;
            opacity: 1;
            width: auto;
        }

        .impact-selector:hover {
            min-width: 240px;
            transition-delay: 0.15s;
        }

        .impact-selector:hover .impact-option {
            width: auto;
            padding: 8px 16px;
            opacity: 1;
            position: relative;
            pointer-events: auto;
            transition-delay: 0.15s;
        }

        @keyframes impactPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .impact-selector::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.2s ease;
        }
        
        .impact-selector:hover::after {
            opacity: 0;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
            transition: 
            min-width 0.8s cubic-bezier(0.4, 0, 0.2, 1),
            box-shadow 0.3s ease,
            background-color 0.3s ease;
            will-change: min-width;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            white-space: nowrap;
            transition: 
            width 0.6s cubic-bezier(0.4, 0, 0.2, 1),
            padding 0.6s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1),
            transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity, width;
        }

        .impact-selector:hover {
            min-width: 110px;
            transition-delay: 0s;
        }

        .impact-selector:hover:active,
        .impact-selector:hover:focus,
        .impact-selector:hover:focus-within,
        .impact-selector:hover:not(:active):after {
            min-width: 240px;
            transition-delay: 0.5s;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            width: 0;
            padding: 0;
            opacity: 0;
            transform: translateX(-10px);
            position: absolute;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-selector:hover .impact-option {
            width: auto;
            padding: 8px 16px;
            opacity: 0;
            transform: translateX(0);
            position: relative;
            pointer-events: none;
            transition-delay: 0.15s;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-selector:hover .impact-option:nth-child(1) { 
            opacity: 1; 
            pointer-events: auto;
            transition-delay: 0.6s;
        }
        .impact-selector:hover .impact-option:nth-child(2) { 
            opacity: 1; 
            pointer-events: auto;
            transition-delay: 0.7s;
        }
        .impact-selector:hover .impact-option:nth-child(3) { 
            opacity: 1; 
            pointer-events: auto;
            transition-delay: 0.8s;
        }

        .impact-selector:not(:hover) .impact-option {
            transition: 
            width 0.4s cubic-bezier(0.4, 0, 0.2, 1),
            padding 0.4s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
            transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-option.selected {
            position: relative;
            opacity: 1;
            width: auto;
            transform: translateX(0);
            transition: none;
        }

        .impact-cell {
            perspective: 1000px;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        .impact-selector::after {
            opacity: 0.5;
            transform: translateY(-50%) rotate(0deg);
            transition: 
            transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-selector:hover::after {
            transform: translateY(-50%) rotate(180deg);
            opacity: 0;
            transition-delay: 0.3s;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
            max-width: 100px;
            transition: max-width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: max-width;
        }

        .impact-selector-inner {
            display: inline-flex;
            min-width: 240px;
            position: relative;
            left: 0;
            transition: left 0.3s ease;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .impact-option.selected {
            opacity: 1;
        }

        .impact-selector:hover {
            max-width: 240px;
        }

        .impact-selector:hover .impact-option {
            opacity: 1;
        }

        .impact-selector:not(:hover) .impact-selector-inner {
            left: 0;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            opacity: 0;
            pointer-events: none;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
            max-width: 100px;
            transition: max-width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: max-width;
            transition-delay: 0.5s;
        }

        .impact-selector-inner {
            display: inline-flex;
            min-width: 240px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            flex-shrink: 0;
            width: 80px;
        }

        .impact-selector:hover {
            max-width: 240px;
        }

        .impact-selector:hover .impact-option {
            opacity: 1;
        }

        .impact-selector:hover .impact-option:nth-child(1) {
            transition-delay: 0.1s;
        }

        .impact-selector:hover .impact-option:nth-child(2) {
            transition-delay: 0.2s;
        }

        .impact-selector:hover .impact-option:nth-child(3) {
            transition-delay: 0.3s;
        }

        .impact-option.selected {
            opacity: 1;
        }

        .impact-selector::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-selector:hover::after {
            opacity: 0;
            transform: translateY(-50%) rotate(180deg);
            transition-delay: 0.2s;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #f1f5f9;
            color: #475569;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            background: #e2e8f0;
        }

        .filter-btn.active {
            background: #2563eb;
            color: white;
        }

        .filter-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .filter-low {
            background-color: #4ade80;
        }

        .filter-medium {
            background-color: #facc15;
        }

        .filter-high {
            background-color: #f43f5e;
        }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .priority-badge-low {
            background-color: rgba(74, 222, 128, 0.2);
            color: #166534;
        }

        .priority-badge-medium {
            background-color: rgba(250, 204, 21, 0.2);
            color: #854d0e;
        }

        .priority-badge-high {
            background-color: rgba(244, 63, 94, 0.2);
            color: #9f1239;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
            max-width: 100px;
            transition: max-width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: max-width;
        }

        .impact-selector-inner {
            display: inline-flex;
            min-width: 240px;
            position: relative;
            transition: transform 0.3s ease;
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
            width: 80px;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            opacity: 0;
            pointer-events: none;
        }

        .impact-selector:hover {
            max-width: 240px;
        }

        .impact-selector:hover .impact-option {
            opacity: 1;
            pointer-events: auto;
        }

        .impact-selector {
            display: inline-flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            background: #f8f9fa;
            min-width: 100px;
            max-width: 100px;
            transition: max-width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: max-width;
            transition-delay: 0.5s;
        }

        .impact-selector-inner {
            display: inline-flex;
            min-width: 240px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-option {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            flex-shrink: 0;
            width: 80px;
        }

        .impact-selector:hover {
            max-width: 240px;
        }

        .impact-selector:hover .impact-option {
            opacity: 1;
        }

        .impact-selector:hover .impact-option:nth-child(1) {
            transition-delay: 0.1s;
        }

        .impact-selector:hover .impact-option:nth-child(2) {
            transition-delay: 0.2s;
        }

        .impact-selector:hover .impact-option:nth-child(3) {
            transition-delay: 0.3s;
        }

        .impact-option.selected {
            opacity: 1;
        }

        .impact-selector::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .impact-selector:hover::after {
            opacity: 0;
            transform: translateY(-50%) rotate(180deg);
            transition-delay: 0.2s;
        }

        .impact-selector:not(:hover) .impact-option:not(.selected) {
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-logo img {
            height: 65px;
            width: auto;
            margin-right: 12px;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .time-column {
            text-align: center;
            line-height: 1.2;
        }

        .time-zone {
            display: block;
            font-size: 0.75em;
            font-weight: normal;
            opacity: 0.9;
            text-transform: none;
        }

        .header-edit-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title {
            font-size: 1.5rem;
            margin: 0;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .header-title.editable {
            background: rgba(255, 243, 205, 0.2);
            border: 2px dashed var(--warning-color);
            outline: none;
        }

        .edit-header-btn {
            padding: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .edit-header-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.25);
        }

        .save-header-btn {
            display: none;
            background: var(--success-color);
        }

        .upload-action {
            position: relative;
            display: inline-block.
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
        }

        .upload-zone {
            position: relative;
            padding: 2rem;
            border: 2px dashed var(--primary-color);
            border-radius: 1rem;
            background: rgba(37, 99, 235, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            margin: 1rem 0;
        }

        .upload-zone.drag-over {
            background: rgba(37, 99, 235, 0.1);
            border-color: #1d4ed8;
            transform: scale(1.02);
        }

        .upload-zone i {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .upload-text {
            color: var(--secondary-color);
            text-align: center;
        }

        .upload-text strong {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-preview {
            display: none;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 1rem;
        }

        .upload-preview i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .upload-progress {
            position: relative;
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .upload-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
            width: 0;
        }

        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .upload-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .upload-modal {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .upload-modal-content {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .upload-zone {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(37, 99, 235, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .upload-zone.drag-over {
            background: rgba(37, 99, 235, 0.1);
            border-color: rgba(37, 99, 235, 0.5);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.2);
        }

        .upload-preview {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #uploadBtn {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #uploadBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.2),
            transparent
            );
            transition: 0.5s;
        }

        #uploadBtn:hover::before {
            left: 100%;
        }

        #uploadBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2);
        }

        #uploadBtn i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        #uploadBtn:hover i {
            transform: translateY(-2px);
        }

        #cancelUpload {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        #cancelUpload:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .upload-text {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .upload-text strong {
            color: var(--primary-color);
            text-decoration: none;
            border-bottom: 2px dashed var(--primary-color);
        }

        .upload-text strong:hover {
            border-bottom-style: solid;
        }

        .upload-progress {
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-progress-bar {
            background: linear-gradient(90deg, var(--primary-color), #1d4ed8);
        }
        </style>
        <style>
        :root {
        --primary-color: #2563eb;
        --secondary-color: #475569;
        --success-color: #16a34a;
        --warning-color: #f59e0b;
        --danger-color: #dc2626;
        --background-color: #f0f5ff;
        --surface-color: #ffffff;
        --glass-bg: rgba(255, 255, 255, 0.15);
        --glass-border: rgba(255, 255, 255, 0.2);
        --text-color: #1e293b;
        --glass-card: #ffffff;
        --glass-card-border: rgba(0, 0, 0, 0.1);
        --highlight-color-start: rgba(37, 99, 235, 0.15);
        --highlight-color-end: transparent;
        }

        [data-theme="dark"] {
        --primary-color: #3b82f6;
        --secondary-color: #94a3b8;
        --background-color: #1a1f2e;
        --surface-color: rgba(30, 41, 59, 0.7);
        --glass-bg: rgba(30, 41, 59, 0.15);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-color: #e2e8f0;
        --glass-card: rgba(30, 41, 59, 0.7);
        --glass-card-border: rgba(255, 255, 255, 0.1);
        --highlight-color-start: rgba(59, 130, 246, 0.2);
        --highlight-color-end: transparent;
        }

        body {
        background: var(--background-color);
        color: var(--text-color);
        transition: all 0.3s ease;
        }

        .theme-toggle {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 0.5rem;
        border-radius: 50%;
        cursor: pointer;
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        }

        .theme-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .container {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        transition: all 0.3s ease;
        }

        [data-theme="dark"] .container {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        }

        table {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        transition: all 0.3s ease;
        }

        [data-theme="dark"] table {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        }

        th {
        background: var(--primary-color);
        color: white !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        position: relative;
        }

        [data-theme="dark"] th {
        background: var(--glass-bg);
        }

        td {
        color: var(--text-color);
        border-bottom: 1px solid var(--glass-border);
        }

        tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
        }

        [data-theme="dark"] tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
        }

        tr:hover {
        background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] tr:hover {
        background: rgba(255, 255, 255, 0.05);
        }

        .modal-content {
        background: var(--glass-card);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-card-border);
        color: var(--text-color);
        }

        .btn {
        background: var(--glass-card);
        color: var(--text-color);
        border: 1px solid var(--glass-card-border);
        transition: all 0.3s ease;
        }

        [data-theme="dark"] .btn {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        }

        tr:nth-child(even) {
        background-color: #f8fafc;
        }

        [data-theme="dark"] tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
        }

        tr:hover {
        background-color: #f0f7ff;
        }

        [data-theme="dark"] tr:hover {
        background: rgba(255, 255, 255, 0.05);
        }

        .nav-header {
        margin: 0 1rem;
        border-radius: 0 0 1rem 1rem;
        padding: 0.25rem 0.5rem;
        width: auto;
        box-sizing: border-box;
        }

        .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0;
        }

        .tz-toggle {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        color: var(--text-color);
        }

        [data-theme="dark"] .tz-toggle {
        color: #fff;
        }

        [data-theme="dark"] .tz-toggle-label {
        color: #fff;
        }

        .nav-header {
        margin: 0;
        border-radius: 0 0 1rem 1rem;
        padding: 0.25rem 1rem;
        width: 100%;
        box-sizing: border-box;
        }

        .nav-container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 0 1rem;
        box-sizing: border-box;
        }

        .tz-toggle {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        color: var(--text-color);
        }

        .filter-btn {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        color: var(--text-color);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        }

        .filter-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .filter-btn.active {
        background: var(--primary-color);
        border-color: transparent;
        }

        [data-theme="dark"] .impact-selector {
        background: var(--glass-card);
        border: 1px solid var(--glass-card-border);
        }

        [data-theme="dark"] .impact-selector:hover {
        background: var(--glass-card);
        }

        [data-theme="dark"] .impact-option:not(.selected) {
        color: var(--text-color);
        }

        [data-theme="dark"] .impact-option:hover:not(.selected) {
        background: rgba(255, 255, 255, 0.05);
        }

        .container,
        .nav-container,
        .tz-toggle,
        .filter-controls {
        max-width: 1200px;
        width: 100%;
        box-sizing: border-box;
        margin-left: auto;
        margin-right: auto;
        }

        [data-theme="dark"] td.editable {
        background-color: rgba(255, 243, 205, 0.1);
        color: #fff;
        border-bottom: 2px dashed var(--warning-color);
        }

        [data-theme="dark"] td.editable:focus {
        background-color: rgba(255, 243, 205, 0.15);
        color: #fff;
        outline: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .info-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        z-index: 1000;
        overflow-y: auto;
        }


    .info-content {
        background: var(--surface-color);
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        max-height: 85vh;
        overflow-y: auto;
    }
    
    .info-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--glass-border);
    }
    
    .info-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .info-section h3 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
    }
    
    .info-steps {
        list-style-type: none;
        padding-left: 20px;
    }
    
    .info-steps li {
        position: relative;
        padding-left: 20px;
        margin-bottom: 0.75rem;
    }
    
    .info-steps li::before {
        content: '';
        position: absolute;
        left: 0;
        color: var(--primary-color);
    }
    
    .info-features {
        list-style-type: none;
        padding-left: 20px;
        columns: 2;
        column-gap: 2rem;
    }
    
    .info-features li {
        margin-bottom: 0.75rem;
        position: relative;
        padding-left: 20px;
        break-inside: avoid;
    }
    
    .info-features li::before {
        content: '';
        position: absolute;
        left: 0;
        color: var(--primary-color);
    }

    .troubleshooting {
        background: var(--glass-card);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
        margin-top: 1.5rem;
    }

    .troubleshooting h3 {
        color: var(--warning-color);
        margin-bottom: 1rem;
    }

    .troubleshooting h4 {
        color: var(--text-color);
        margin: 1rem 0 0.5rem;
        font-size: 1rem;
    }
    
    .troubleshooting h4:first-of-type {
        margin-top: 0;
    }
    
    .troubleshooting ul {
        padding-left: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .troubleshooting li {
        margin-bottom: 0.5rem;
    }
    
    .extraction-warning {
        background: rgba(244, 63, 94, 0.1);
        border-left: 4px solid var(--danger-color);
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 0.5rem 0.5rem 0;
    }
    
    @media (max-width: 768px) {
        .info-content {
            margin: 1rem;
            padding: 1.5rem;
            max-height: 90vh;
        }
        
        .info-features {
            columns: 1;
        }
    }
    /* Email Comparison View Styles */
.comparison-view {
  width: 90%;
  max-width: 1200px;
  height: 85vh;
  display: flex;
  flex-direction: column;
}

.comparison-container {
  display: flex;
  flex: 1;
  overflow: hidden;
  gap: 20px;
  height: calc(100% - 120px);
}

.email-viewer, .parsed-data-viewer {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid var(--glass-border);
  overflow: hidden;
}

.section-title {
  padding: 10px 15px;
  margin: 0;
  background: var(--primary-color);
  color: white;
  font-size: 16px;
  font-weight: 600;
}

.email-body {
  flex: 1;
  overflow: auto;
  padding: 15px;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 14px;
  line-height: 1.5;
}

.parsed-data-container {
  flex: 1;
  overflow: auto;
  padding: 10px;
}

.parsed-data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0;
}

.parsed-data-table th, 
.parsed-data-table td {
  text-align: left;
  padding: 8px 12px;
  border: 1px solid var(--glass-border);
}

.parsed-data-table tr {
  border-left: none;
  border-right: none;
}

.comparison-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 0 0 8px 8px;
  margin-top: 20px;
}

.search-box {
  display: flex;
  align-items: center;
  gap: 8px;
}

#emailSearch {
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid var(--glass-border);
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-color);
}

#searchBtn {
  padding: 8px 12px;
  border-radius: 4px;
  border: none;
  background: var(--primary-color);
  color: white;
  cursor: pointer;
}

#searchResults {
  font-size: 14px;
  color: var(--text-color);
}

.legend {
  display: flex;
  gap: 15px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 14px;
}

.highlight-service, .highlight-date, .highlight-time {
  display: inline-block;
  width: 15px;
  height: 15px;
  border-radius: 3px;
}

.highlight-service {
  background-color: rgba(37, 99, 235, 0.2);
}

.highlight-date {
  background-color: rgba(16, 185, 129, 0.2);
}

.highlight-time {
  background-color: rgba(245, 158, 11, 0.2);
}

/* Highlight styles for email content */
.highlight-match {
  background-color: rgba(253, 224, 71, 0.3);
  border-radius: 3px;
  padding: 2px 0;
}

.email-body .highlight-service {
  background-color: rgba(37, 99, 235, 0.2);
  border-radius: 3px;
  padding: 2px 0;
}

.email-body .highlight-date {
  background-color: rgba(16, 185, 129, 0.2);
  border-radius: 3px;
  padding: 2px 0;
}

.email-body .highlight-time {
  background-color: rgba(245, 158, 11, 0.2);
  border-radius: 3px;
  padding: 2px 0;
}

.parsed-data-table tr.highlight-row {
  background-color: rgba(37, 99, 235, 0.1);
}

.layout-stacked .comparison-container {
  flex-direction: column;
}

.layout-stacked .email-viewer, 
.layout-stacked .parsed-data-viewer {
  max-height: 50%;
}

@media (max-width: 768px) {
  .comparison-container {
    flex-direction: column;
  }

  .email-viewer, .parsed-data-viewer {
    max-height: 50%;
  }
}
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 1001; /* Increase z-index to be above nav bar */
  overflow-y: auto;
}

.modal-content {
  position: relative;
  background: var(--glass-card);
  margin: 70px auto; /* Increased top margin to avoid nav overlap */
  padding: 20px;
  width: 90%;
  max-width: 1100px;
  max-height: 85vh;
  overflow-y: auto;
  border-radius: 8px;
  border: 1px solid var(--glass-card-border);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.modal-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  padding: 10px;
  background: var(--glass-bg);
  border-radius: 8px;
  border: 1px solid var(--glass-border);
}

.tool-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  background: var(--glass-card);
  color: var(--text-color);
}

.tool-btn:hover {
  transform: translateY(-1px);
  background: var(--primary-color);
  color: white;
}

/* Email viewer styles with dark mode support */
.comparison-container {
  display: flex;
  flex: 1;
  overflow: hidden;
  gap: 20px;
  height: calc(100% - 120px);
}

.email-viewer, .parsed-data-viewer {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--glass-bg);
  border-radius: 8px;
  border: 1px solid var(--glass-border);
  overflow: hidden;
}

.section-title {
  padding: 10px 15px;
  margin: 0;
  background: var(--primary-color);
  color: white;
  font-size: 16px;
  font-weight: 600;
}

.email-body {
  flex: 1;
  overflow: auto;
  padding: 15px;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-color);
  background: var(--glass-card);
  height: 100%;
  min-height: 450px; /* Increased height now that header is removed */
}

.parsed-data-container {
  flex: 1;
  overflow: auto;
  padding: 10px;
  background: var(--glass-card);
}

.parsed-data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0;
  background: var(--glass-card);
  color: var(--text-color);
}

.parsed-data-table th, 
.parsed-data-table td {
  text-align: left;
  padding: 8px 12px;
  border: 1px solid var(--glass-border);
  color: var(--text-color);
}

.comparison-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: var(--glass-bg);
  border-radius: 0 0 8px 8px;
  margin-top: 20px;
  border-top: 1px solid var(--glass-border);
  color: var(--text-color);
}

#emailSearch {
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid var(--glass-border);
  background: var(--glass-bg);
  color: var(--text-color);
}

#searchBtn {
  padding: 8px 12px;
  border-radius: 4px;
  border: none;
  background: var(--primary-color);
  color: white;
  cursor: pointer;
}

.legend {
  display: flex;
  gap: 15px;
  color: var(--text-color);
}

/* Updated search result and highlight styles */
.highlight-match {
  background-color: rgba(253, 224, 71, 0.3);
  border-radius: 3px;
  padding: 2px 0;
}

[data-theme="dark"] .highlight-match {
  background-color: rgba(253, 224, 71, 0.4);
}

.email-body .highlight-service {
  background-color: rgba(37, 99, 235, 0.2);
  border-radius: 3px;
  padding: 2px 0;
}

[data-theme="dark"] .email-body .highlight-service {
  background-color: rgba(37, 99, 235, 0.4);
}

.email-body .highlight-date {
  background-color: rgba(16, 185, 129, 0.2);
  border-radius: 3px;
  padding: 2px 0;
}

[data-theme="dark"] .email-body .highlight-date {
  background-color: rgba(16, 185, 129, 0.4);
}

.email-body .highlight-time {
  background-color: rgba(245, 158, 11, 0.2);
  border-radius: 3px;
  padding: 2px 0;
}

[data-theme="dark"] .email-body .highlight-time {
  background-color: rgba(245, 158, 11, 0.4);
}
</style>
</head>
<body>
    <header class="nav-header">
        <nav class="nav-container">
            <a href="https://internal.ericsson.com/" class="nav-logo">
                <img src="https://www.ericsson.com/4981bb/assets/global/qbank/2021/04/21/e-con-vertical-1500x1500px-88604d41d8cd98f00b204e9800998ecf8427e.png" alt="Ericsson Logo">
                Welcome!
            </a>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class='bx bx-home-alt'></i>
                    Home
                </a>
                <a href="#" class="nav-link" id="howItWorksBtn">
                    <i class='bx bx-info-circle'></i>
                    How it Works
                </a>
                <a href="#" class="nav-link">
                    <i class='bx bx-shield-quarter'></i>
                    Policy
                </a>
                <a href="#" class="nav-link">
                    <i class='bx bx-user'></i>
                    About
                </a>
                <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </nav>
    </header>

    <form id="uploadForm" action="/" method="post" enctype="multipart/form-data" style="display: none;">
        <input type="file" name="file" id="fileInput" accept=".msg">
    </form>

    <div id="infoModal" class="info-modal">
        <div class="info-content">
            <span class="close">&times;</span>
            <h2>How It Works</h2>
            
            <div class="info-section">
                <h3><i class="fas fa-rocket"></i> Getting Started</h3>
                <ol class="info-steps">
                    <li>Click <strong>"Upload MSG"</strong> to select a maintenance notification email</li>
                    <li>Review the extracted maintenance information in the table</li>
                    <li>Use <strong>Edit</strong> buttons to correct any information if needed</li>
                    <li>Toggle between Sweden time and IST with the time zone switch</li>
                    <li>Filter by priority to focus on the most critical changes</li>
                </ol>
                
                <div class="extraction-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Important:</strong> AI extraction might not be perfect. Always double-check dates, times, and service names before sharing or making decisions based on this information.
                </div>
            </div>
            
            <div class="info-section">
                <h3><i class="fas fa-cogs"></i> Key Features</h3>
                <ul class="info-features">
                    <li><strong>Auto-extraction</strong> of maintenance windows</li>
                    <li><strong>Time zone conversion</strong> Sweden  IST</li>
                    <li><strong>Priority assignment</strong> for changes</li>
                    <li><strong>Smart filters</strong> for critical work</li>
                    <li><strong>Inline editing</strong> of all fields</li>
                    <li><strong>Dark/Light mode</strong> for comfort</li>
                </ul>
            </div>
            
            <div class="info-section troubleshooting">
                <h3><i class="fas fa-exclamation-triangle"></i> Common Issues</h3>
                
                <h4>Time Conversion</h4>
                <ul>
                    <li>Use 24-hour format (HH:MM) for accurate conversion</li>
                    <li>For time ranges, format as "09:00-11:00" without spaces</li>
                    <li>Double-check converted times match expected schedules</li>
                </ul>
                
                <h4>Upload Problems</h4>
                <ul>
                    <li>Only .msg files are supported (from Outlook)</li>
                    <li>Large attachments may cause processing delays</li>
                    <li>Non-standard email formats may extract incorrectly</li>
                </ul>
                
                <h4>Data Accuracy</h4>
                <ul>
                    <li>Always verify extracted information against original email</li>
                    <li>Check for missing services or incorrect time windows</li>
                    <li>Manual additions may be needed for complex notifications</li>
                </ul>
            </div>
        </div>
    </div>

        <div class="header">
            <div class="header-edit-group">
                <h1 class="header-title" contenteditable="false" id="headerTitle">{{ header_title }}</h1>
                <button class="edit-header-btn" id="editHeaderBtn" title="Edit Title">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="edit-header-btn save-header-btn" id="saveHeaderBtn" title="Save Title">
                    <i class="fas fa-save"></i>
                </button>
            </div>
            <div class="actions">
                <button class="btn primary-btn" id="uploadBtn">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload MSG</span>
                </button>
                <button class="btn primary-btn" id="downloadHtml">
                    <i class="fas fa-download"></i> Download HTML
                </button>
                <button class="btn secondary-btn" id="viewOriginal">
                    <i class="fas fa-envelope"></i> View Original Email
                </button>
                <button class="btn success-btn" id="addRow">
                    <i class="fas fa-plus"></i> Add Row
                </button>
                <button class="btn danger-btn" id="resetForm">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <!-- Add this new button for data synchronization -->
                <button class="btn primary-btn" id="syncData">
                    <i class="fas fa-sync-alt"></i> Sync Data
                </button>
            </div>
        </div>

        <div class="tz-toggle">
            <div class="tz-toggle-label">
                <i class="fas fa-globe"></i>
                <span id="tzLabel">Show times in IST</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="tzToggle">
                <span class="slider"></span>
            </label>
            <div class="time-conversion-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Time format should be HH:MM for accurate conversion</span>
            </div>
        </div>

        <div class="filter-controls">
            <button class="filter-btn" data-filter="all">
            <i class="fas fa-filter"></i> All
            </button>
            <button class="filter-btn" data-filter="high">
            <span class="filter-indicator filter-high"></span> High Priority
            </button>
            <button class="filter-btn" data-filter="medium">
            <span class="filter-indicator filter-medium"></span> Medium Priority
            </button>
            <button class="filter-btn" data-filter="low">
            <span class="filter-indicator filter-low"></span> Low Priority
            </button>
        </div>

        <table id="changeTable">
            <thead>
            <tr>
                <th class="sortable">Affected Service/Servers</th>
                <th class="sortable">Date</th>
                <th class="sortable time-column">
                Start Time
                <span class="time-zone">(Sweden)</span>
                </th>
                <th class="sortable time-column">
                End Time
                <span class="time-zone">(Sweden)</span>
                </th>
                <th class="sortable">End Date</th>
                <th class="sortable">Comments</th>
                <th class="sortable">Impact Priority</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for service in data.services %}
            <tr data-priority="low">
                <td>{{ service.name }}</td>
                <td>{{ data.date }}</td>
                <td>{{ service.start_time }}</td>
                <td>{{ service.end_time }}</td>
                <td>{{ service.end_date }}</td>
                <td>{{ service.comments }}</td>
                <td class="impact-cell">
                <div class="impact-selector" data-value="low">
                    <div class="impact-selector-inner">
                    <div class="impact-option impact-option-low selected" data-value="low">
                        <span class="impact-dot"></span> Low
                    </div>
                    <div class="impact-option impact-option-medium" data-value="medium">
                        <span class="impact-dot"></span> Medium
                    </div>
                    <div class="impact-option impact-option-high" data-value="high">
                        <span class="impact-dot"></span> High
                    </div>
                    </div>
                </div>
                </td>
                <td class="action-cell">
                <button class="table-btn edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="table-btn save-btn" style="display: none;" title="Save"><i class="fas fa-save"></i></button>
                <button class="table-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>

        
        <div class="confirm-dialog" id="deleteConfirmDialog">
        <div class="confirm-content">
            <h3 class="confirm-title">Confirm Deletion</h3>
            <p class="confirm-message">Are you sure you want to delete this row? This action cannot be undone.</p>
            <div class="confirm-actions">
            <button class="btn secondary-btn" id="cancelDelete">Cancel</button>
            <button class="btn danger-btn" id="confirmDelete">Delete</button>
            </div>
        </div>
        </div>

        
        <div id="emailModal" class="modal">
  <div class="modal-content comparison-view">
    <span class="close">&times;</span>
    
    <div class="modal-toolbar">
      <button class="tool-btn primary-btn" id="copyEmail">
        <i class="fas fa-copy"></i> Copy All
      </button>
      <button class="tool-btn secondary-btn" id="downloadText">
        <i class="fas fa-file-download"></i> Download as Text
      </button>
      <button class="tool-btn" id="toggleWordWrap">
        <i class="fas fa-align-left"></i> Toggle Word Wrap
      </button>
      <button class="tool-btn" id="toggleLayout">
        <i class="fas fa-columns"></i> Toggle Layout
      </button>
      <button class="tool-btn" id="highlightData">
        <i class="fas fa-highlighter"></i> Highlight Data
      </button>
      <button class="tool-btn" id="increaseFontSize">
        <i class="fas fa-search-plus"></i>
      </button>
      <button class="tool-btn" id="decreaseFontSize">
        <i class="fas fa-search-minus"></i>
      </button>
      <button class="tool-btn primary-btn" id="editDataBtn">
        <i class="fas fa-edit"></i> Edit Data
      </button>
      <button class="tool-btn success-btn" id="saveDataBtn" style="display: none;">
        <i class="fas fa-save"></i> Save Changes
      </button>
    </div>

    <div class="comparison-container">
      <div class="email-viewer">
        <h3 class="section-title">Original Email</h3>
        <!-- Removed the email-header section with subject and date -->
        <div class="email-body" id="emailBody">{{ data.original_body }}</div>
      </div>

      <div class="parsed-data-viewer">
        <h3 class="section-title">Extracted Data</h3>
        <div class="parsed-data-container">
          <table class="parsed-data-table">
            <thead>
              <tr>
                <th>Service/Servers</th>
                <th>Date</th>
                <th>Time Window</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody id="parsedDataBody">
              {% for service in data.services %}
              <tr data-service="{{ service.name }}">
                <td>{{ service.name }}</td>
                <td>{{ data.date }}</td>
                <td>{{ service.start_time }} - {{ service.end_time }}</td>
                <td>{{ service.comments }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="comparison-footer">
      <div class="search-box">
        <input type="text" id="emailSearch" placeholder="Search in email...">
        <button id="searchBtn"><i class="fas fa-search"></i></button>
        <span id="searchResults"></span>
      </div>
      <div class="legend">
        <span class="legend-item"><span class="highlight-service"></span> Service Name</span>
        <span class="legend-item"><span class="highlight-date"></span> Date</span>
        <span class="legend-item"><span class="highlight-time"></span> Time</span>
      </div>
    </div>
  </div>
</div>

        <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <div class="upload-zone" id="uploadZone">
            <i class="fas fa-file-upload"></i>
            <div class="upload-text">
                Drag and drop your .msg file here<br>
                or <strong>click to browse</strong>
            </div>
            <div class="upload-preview" id="uploadPreview">
                <i class="fas fa-file-alt"></i>
                <div>
                <div class="file-name"></div>
                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
                </div>
            </div>
            </div>
            <button class="btn secondary-btn" id="cancelUpload" style="margin-top: 1rem;">
            Cancel
            </button>
        </div>
        </div>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.3.1/luxon.min.js"></script>
        <script>
        
        const modal = document.getElementById('emailModal');
        const viewOriginalBtn = document.getElementById('viewOriginal');
        const closeBtn = document.getElementsByClassName('close')[0];
        const confirmDialog = document.getElementById('deleteConfirmDialog');
        let rowToDelete = null;

        viewOriginalBtn.onclick = function() {
            modal.style.display = "block";
        }

        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
            modal.style.display = "none";
            }
            if (event.target == confirmDialog) {
            confirmDialog.classList.remove('active');
            }
        }

        
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', function() {
            const table = this.closest('table');
            const index = Array.from(this.parentNode.children).indexOf(this);
            const isAsc = this.classList.contains('sorted-asc');
            
            
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            
            this.classList.add(isAsc ? 'sorted-desc' : 'sorted-asc');
            
            
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            rows.sort((a, b) => {
                const aValue = a.cells[index].textContent;
                const bValue = b.cells[index].textContent;
                
                if (isAsc) {
                return bValue.localeCompare(aValue);
                } else {
                return aValue.localeCompare(bValue);
                }
            });
            
            
            const tbody = table.querySelector('tbody');
            rows.forEach(row => tbody.appendChild(row));
            
            
            rows.forEach(row => {
                row.classList.add('highlight-row');
                setTimeout(() => row.classList.remove('highlight-row'), 1500);
            });
            });
        });


        function applyRowHighlight(row) {
            if (!row) return;
            
            row.classList.remove('highlight-row');
            
            void row.offsetWidth;
            
            row.classList.add('highlight-row');
            
            setTimeout(() => row.classList.remove('highlight-row'), 1500);
        }

        document.getElementById('addRow').addEventListener('click', function() {
            const tbody = document.querySelector('tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-priority', 'low');
            
            const emptyState = tbody.querySelector('.empty-state');
            if (emptyState) {
            tbody.removeChild(emptyState);
            }
            
            newRow.innerHTML = `
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td class="impact-cell">
                <div class="impact-selector" data-value="low">
                <div class="impact-selector-inner">
                    <div class="impact-option impact-option-low selected" data-value="low">
                    <span class="impact-dot"></span> Low
                    </div>
                    <div class="impact-option impact-option-medium" data-value="medium">
                    <span class="impact-dot"></span> Medium
                    </div>
                    <div class="impact-option impact-option-high" data-value="high">
                    <span class="impact-dot"></span> High
                    </div>
                </div>
                </div>
            </td>
            <td class="action-cell">
                <button class="table-btn edit-btn" title="Edit" style="display: none;"><i class="fas fa-edit"></i></button>
                <button class="table-btn save-btn" title="Save" style="display: inline-flex;"><i class="fas fa-save"></i></button>
                <button class="table-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
            `;
            tbody.appendChild(newRow);
            
            applyRowHighlight(newRow);

            initImpactSelector(newRow);
            
            applyActiveFilter();
        });

        function checkEmptyTable() {
            const tbody = document.querySelector('tbody');
            if (tbody.children.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.classList.add('empty-state');
            emptyRow.innerHTML = `
                <td colspan="6">
                <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                <div class="empty-state-text">No changes found</div>
                <button class="btn primary-btn" id="emptyAddRow">
                    <i class="fas fa-plus"></i> Add First Row
                </button>
                </td>
            `;
            tbody.appendChild(emptyRow);
            
            document.getElementById('emptyAddRow').addEventListener('click', function() {
                document.getElementById('addRow').click();
            });
            }
        }

        document.querySelector('table').addEventListener('click', function(e) {
            if (e.target.closest('.edit-btn')) {
            const row = e.target.closest('tr');
            const cells = row.getElementsByTagName('td');
            for (let i = 0; i < cells.length - 1; i++) {
                cells[i].contentEditable = true;
                cells[i].classList.add('editable');
            }
            row.querySelector('.edit-btn').style.display = 'none';
            row.querySelector('.save-btn').style.display = 'inline-flex';
            }
            
            if (e.target.closest('.save-btn')) {
            const row = e.target.closest('tr');
            const cells = row.getElementsByTagName('td');
            
            const startTimeCell = cells[2];
            const endTimeCell = cells[3];
            
            startTimeCell.dataset.original = startTimeCell.textContent;
            endTimeCell.dataset.original = endTimeCell.textContent;

            for (let i = 0; i < cells.length - 1; i++) {
                cells[i].contentEditable = false;
                cells[i].classList.remove('editable');
            }
            row.querySelector('.save-btn').style.display = 'none';
            row.querySelector('.edit-btn').style.display = 'inline-flex';
            
            applyRowHighlight(row);
            
            const rowData = {
                service: cells[0].textContent,
                date: cells[1].textContent,
                startTime: cells[2].textContent,
                endTime: cells[3].textContent,
                comments: cells[4].textContent,
                impactPriority: row.querySelector('.impact-selector').getAttribute('data-value')
            };
            
            fetch('/save-changes', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowData)
            });
            }
            
            if (e.target.closest('.delete-btn')) {
            rowToDelete = e.target.closest('tr');
            confirmDialog.classList.add('active');
            }
        });
        
        document.getElementById('cancelDelete').addEventListener('click', function() {
            confirmDialog.classList.remove('active');
            rowToDelete = null;
        });
        
        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (rowToDelete) {
            rowToDelete.style.opacity = '0';
            rowToDelete.style.transform = 'translateX(20px)';
            setTimeout(() => {
                rowToDelete.remove();
                checkEmptyTable();
                
                const cells = rowToDelete.getElementsByTagName('td');
                const rowData = {
                service: cells[0].textContent,
                date: cells[1].textContent
                };
                
                fetch('/delete-row', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowData)
                });
                
                rowToDelete = null;
            }, 300);
            }
            confirmDialog.classList.remove('active');
        });

        document.addEventListener('DOMContentLoaded', function() {
            checkEmptyTable();

            const rows = document.querySelectorAll('#changeTable tbody tr');
            rows.forEach(row => initImpactSelector(row));
            
            const allFilterBtn = document.querySelector('.filter-btn[data-filter="all"]');
            if (allFilterBtn) {
            allFilterBtn.classList.add('active');
            }

            document.querySelector('.filter-controls').addEventListener('click', function(e) {
            const filterBtn = e.target.closest('.filter-btn');
            if (filterBtn) {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                });
                filterBtn.classList.add('active');
                
                applyActiveFilter();
            }
            });
        });


        function initImpactSelector(row) {
            if (!row) return;
        
            const impactOptions = row.querySelectorAll('.impact-option');
            const selector = row.querySelector('.impact-selector');
            const innerContainer = selector?.querySelector('.impact-selector-inner');
            
            if (!impactOptions.length || !selector || !innerContainer) return;
            
            impactOptions.forEach(option => {
            option.addEventListener('click', function() {
                const tr = this.closest('tr');
                if (!tr) return;
                
                const priority = this.getAttribute('data-value');
                
                impactOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                selector.setAttribute('data-value', priority);
                tr.setAttribute('data-priority', priority);
                
                this.style.animation = 'none';
                setTimeout(() => {
                this.style.animation = 'impactPulse 0.8s ease-in-out';
                }, 100);
                
                applyActiveFilter();
            });
            });
        }

        function applyActiveFilter() {
            const activeFilter = document.querySelector('.filter-btn.active');
            const filterValue = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
            const rows = document.querySelectorAll('#changeTable tbody tr:not(.empty-state)');
            
            console.log('Applying filter:', filterValue);
            
            rows.forEach(row => {
            const priority = row.getAttribute('data-priority');
            if (filterValue === 'all' || priority === filterValue) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
            });
        }

        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', function() {
            const table = this.closest('table');
            const index = Array.from(this.parentNode.children).indexOf(this);
            const isAsc = this.classList.contains('sorted-asc');
            
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            this.classList.add(isAsc ? 'sorted-desc' : 'sorted-asc');
            
            const rows = Array.from(table.querySelectorAll('tbody tr:not(.empty-state)'));
            rows.sort((a, b) => {
                if (index === 5) {
                const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                const aPriority = a.getAttribute('data-priority');
                const bPriority = b.getAttribute('data-priority');
                
                if (isAsc) {
                    return priorityOrder[bPriority] - priorityOrder[aPriority];
                } else {
                    return priorityOrder[aPriority] - priorityOrder[bPriority];
                }
                } else {
                const aValue = a.cells[index].textContent;
                const bValue = b.cells[index].textContent;
                
                if (isAsc) {
                    return bValue.localeCompare(aValue);
                } else {
                    return aValue.localeCompare(bValue);
                }
                }
            });
            
            const tbody = table.querySelector('tbody');
            rows.forEach(row => tbody.appendChild(row));
            
            rows.forEach(row => applyRowHighlight(row));
            
            applyActiveFilter();
            });
        });

        const tzToggle = document.getElementById('tzToggle');
        const DateTime = luxon.DateTime;

        function convertToIST(timeStr, dateStr) {
            try {
            if (timeStr === "-") {
                return "-";
            }
            
            if (timeStr.includes('-')) {
                const [start, end] = timeStr.split('-');
                return `${convertToIST(start.trim(), dateStr)}-${convertToIST(end.trim(), dateStr)}`;
            }

            const dt = DateTime.fromFormat(`${dateStr} ${timeStr}`, 'yyyy-MM-dd HH:mm', {
                zone: 'Europe/Stockholm'
            });
            
            const istTime = dt.setZone('Asia/Kolkata');
            return istTime.toFormat('hh:mm a');
            } catch (e) {
            console.error('Error converting time:', e);
            return 'Invalid time';
            }
        }

        tzToggle.addEventListener('change', function() {
            const timeColumns = document.querySelectorAll('.time-column');
            const tzLabel = document.getElementById('tzLabel');
            const warning = document.querySelector('.time-conversion-warning');
            
            if (this.checked) {
            timeColumns[0].innerHTML = 'Start Time<span class="time-zone">(IST)</span>';
            timeColumns[1].innerHTML = 'End Time<span class="time-zone">(IST)</span>';
            tzLabel.textContent = 'Showing times in IST';
            } else {
            timeColumns[0].innerHTML = 'Start Time<span class="time-zone">(Sweden)</span>';
            timeColumns[1].innerHTML = 'End Time<span class="time-zone">(Sweden)</span>';
            tzLabel.textContent = 'Show times in IST';
            }
            
            warning.style.display = this.checked ? 'flex' : 'none';

            const rows = document.querySelectorAll('#changeTable tbody tr');
            const dateCell = rows[0]?.querySelector('td:nth-child(2)');
            const date = dateCell?.textContent || '2025-02-15';

            rows.forEach(row => {
            const startTimeCell = row.querySelector('td:nth-child(3)');
            const endTimeCell = row.querySelector('td:nth-child(4)');
            
            if (startTimeCell && endTimeCell) {
                if (this.checked) {
                if (!startTimeCell.dataset.original) {
                    startTimeCell.dataset.original = startTimeCell.textContent;
                }
                if (!endTimeCell.dataset.original) {
                    endTimeCell.dataset.original = endTimeCell.textContent;
                }
                
                const startTimeConverted = convertToIST(startTimeCell.dataset.original, date);
                const endTimeConverted = convertToIST(endTimeCell.dataset.original, date);
                
                startTimeCell.textContent = startTimeConverted;
                endTimeCell.textContent = endTimeConverted;
                } else {
                if (startTimeCell.dataset.original) {
                    startTimeCell.textContent = startTimeCell.dataset.original;
                }
                if (endTimeCell.dataset.original) {
                    endTimeCell.textContent = endTimeCell.dataset.original;
                }
                }
            }
            });
        });

        document.getElementById('copyEmail').addEventListener('click', function() {
            const textToCopy = document.getElementById('emailBody').textContent;
            navigator.clipboard.writeText(textToCopy)
            .then(() => alert('Email content copied to clipboard!'));
        });

        document.getElementById('downloadText').addEventListener('click', function() {
            const text = document.getElementById('emailBody').textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'email_content.txt';
            a.click();
        });

        document.getElementById('toggleWordWrap').addEventListener('click', function() {
            const emailBody = document.getElementById('emailBody');
            emailBody.style.whiteSpace = 
            emailBody.style.whiteSpace === 'pre' ? 'pre-wrap' : 'pre';
        });

        let fontSize = 14;
        document.getElementById('increaseFontSize').addEventListener('click', function() {
            fontSize = Math.min(fontSize + 2, 24);
            document.getElementById('emailBody').style.fontSize = `${fontSize}px`;
        });

        document.getElementById('decreaseFontSize').addEventListener('click', function() {
            fontSize = Math.max(fontSize - 2, 10);
            document.getElementById('emailBody').style.fontSize = `${fontSize}px`;
        });

        const infoModal = document.getElementById('infoModal');
        const howItWorksBtn = document.getElementById('howItWorksBtn');

        howItWorksBtn.onclick = function() {
            infoModal.style.display = "block";
        }

        window.onclick = function(event) {
            if (event.target == infoModal) {
            infoModal.style.display = "none";
            }
            if (event.target == modal) {
            modal.style.display = "none";
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
            if (infoModal.style.display === "block") {
                infoModal.style.display = "none";
            }
            if (modal.style.display === "block") {
                modal.style.display = "none";
            }
            }
        });

        document.getElementById('downloadHtml').addEventListener('click', function() {
            const styleSheets = Array.from(document.styleSheets);
            let styles = '';
            styleSheets.forEach(sheet => {
            try {
                Array.from(sheet.cssRules).forEach(rule => {
                styles += rule.cssText;
                });
            } catch (e) {
                console.log('Could not read stylesheet:', e);
            }
            });

            let tableBody = '';
            document.querySelectorAll('#changeTable tbody tr:not(.empty-state):not([style*="display: none"])').forEach(row => {
            const cells = row.cells;
            const priority = row.getAttribute('data-priority');
            
            if (cells.length >= 6) {
                tableBody += `
                <tr>
                <td>${cells[0].textContent}</td>
                <td>${cells[1].textContent}</td>
                <td>${cells[2].textContent}</td>
                <td>${cells[3].textContent}</td>
                <td>${cells[4].textContent}</td>
                <td>${cells[5].textContent}</td>
                <td>
                    <div class="priority-badge priority-badge-${priority}">
                    <span class="filter-indicator filter-${priority}"></span>
                    ${priority.charAt(0).toUpperCase() + priority.slice(1)}
                    </div>
                </td>
                </tr>`;
            }
            });

            const tableHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Management Table</title>
    <style>
        ${styles}
    </style>
</head>
<body>
    <div class="container">
        <table id="changeTable">
            <thead>
                <tr>
                    <th>
                        Affected Service/Servers
                        <span class="policy-icon">i</span>
                        <span class="policy-tooltip">
                            Company Policy: This document is confidential and should only be shared with authorized personnel.
                            Changes must be approved through proper channels before implementation.
                        </span>
                    </th>
                    <th>Date</th>
                    <th>Start Time-IST</th>
                    <th>End Time-IST</th>
                    <th>End Date</th>
                    <th>Comments</th>
                    <th>Impact Priority</th>
                </tr>
            </thead>
            <tbody>
                ${tableBody}
            </tbody>
        </table>
    </div>
</body>
</html>`;

            const blob = new Blob([tableHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'change_management.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        const headerTitle = document.getElementById('headerTitle');
        const editHeaderBtn = document.getElementById('editHeaderBtn');
        const saveHeaderBtn = document.getElementById('saveHeaderBtn');

        editHeaderBtn.addEventListener('click', function() {
            headerTitle.contentEditable = true;
            headerTitle.classList.add('editable');
            headerTitle.focus();
            editHeaderBtn.style.display = 'none';
            saveHeaderBtn.style.display = 'flex';
        });

        saveHeaderBtn.addEventListener('click', function() {
            headerTitle.contentEditable = false;
            headerTitle.classList.remove('editable');
            editHeaderBtn.style.display = 'flex';
            saveHeaderBtn.style.display = 'none';
            fetch('/save-title', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: headerTitle.textContent
            })
            });
        });

        headerTitle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
            e.preventDefault();
            saveHeaderBtn.click();
            } else if (e.key === 'Escape') {
            headerTitle.contentEditable = false;
            headerTitle.classList.remove('editable');
            editHeaderBtn.style.display = 'flex';
            saveHeaderBtn.style.display = 'none';
            }
        });

        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
            toast.style.display = 'none';
            }, 5000);
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (this.files.length > 0) {
            const file = this.files[0];
            if (!file.name.toLowerCase().endswith('.msg')) {
                showError('Please upload a .MSG file');
                return;
            }
            
            showLoading();
            document.getElementById('uploadForm').submit();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            initializeFileUpload();
            
            const rows = document.querySelectorAll('#changeTable tbody tr');
            if (rows) {
            rows.forEach(row => initImpactSelector(row));
            }
            
            const allFilterBtn = document.querySelector('.filter-btn[data-filter="all"]');
            if (allFilterBtn) {
            allFilterBtn.classList.add('active');
            }
            
            checkEmptyTable();
        });

        function initializeFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadForm = document.getElementById('uploadForm');
            const loadingOverlay = document.querySelector('.loading-overlay');
            const errorToast = document.getElementById('errorToast');

            if (fileInput && uploadForm) {
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                const file = this.files[0];
                if (!file.name.toLowerCase().endswith('.msg')) {
                    showError('Please upload a .MSG file');
                    return;
                }
                
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
                
                uploadForm.submit();
                }
            });
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadModal = document.getElementById('uploadModal');
            const uploadZone = document.getElementById('uploadZone');
            const uploadPreview = document.getElementById('uploadPreview');
            const cancelUpload = document.getElementById('cancelUpload');
            const fileInput = document.getElementById('fileInput');

            uploadBtn.addEventListener('click', () => {
                uploadModal.style.display = 'flex';
                uploadZone.style.display = 'flex';
            });

            cancelUpload.addEventListener('click', () => {
                uploadModal.style.display = 'none';
                uploadPreview.style.display = 'none';
                uploadZone.classList.remove('drag-over');
            });


            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    
                    if (!file.name.toLowerCase().endsWith('.msg')) {
                        alert('Please upload a .MSG file');
                        return;
                    }
                    
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    uploadPreview.style.display = 'flex';
                    uploadPreview.querySelector('.file-name').textContent = file.name;
                    
                    const progressBar = uploadPreview.querySelector('.upload-progress-bar');
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10;
                        progressBar.style.width = `${progress}%`;
                        if (progress >= 100) {
                            clearInterval(interval);
                            document.getElementById('uploadForm').submit();
                        }
                    }, 100);
                }
            });

            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (!file.name.toLowerCase().endsWith('.msg')) {
                        alert('Please upload a .MSG file');
                        return;
                    }

                    uploadPreview.style.display = 'flex';
                    uploadPreview.querySelector('.file-name').textContent = file.name;

                    const progressBar = uploadPreview.querySelector('.upload-progress-bar');
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10;
                        progressBar.style.width = `${progress}%`;
                        if (progress >= 100) {
                            clearInterval(interval);
                            document.getElementById('uploadForm').submit();
                        }
                    }, 100);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const icon = themeToggle.querySelector('i');
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            function updateThemeIcon(theme) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        });

        document.getElementById('resetForm').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset the form? This will clear all data.')) {
                window.location.href = '/';
            }
        });

document.addEventListener('DOMContentLoaded', function() {
  // Existing initialization code...

  // New email comparison functionality
  const toggleLayoutBtn = document.getElementById('toggleLayout');
  const highlightDataBtn = document.getElementById('highlightData');
  const searchBtn = document.getElementById('searchBtn');
  const emailSearch = document.getElementById('emailSearch');
  const searchResults = document.getElementById('searchResults');
  const emailBody = document.getElementById('emailBody');
  const parsedDataRows = document.querySelectorAll('#parsedDataBody tr');
  
  // New edit functionality
  const editDataBtn = document.getElementById('editDataBtn');
  const saveDataBtn = document.getElementById('saveDataBtn');
  let isEditing = false;
  
  // Toggle edit mode for the parsed data table
  editDataBtn.addEventListener('click', function() {
    isEditing = true;
    editDataBtn.style.display = 'none';
    saveDataBtn.style.display = 'inline-flex';
    
    // Make all cells in the parsed data table editable
    const cells = document.querySelectorAll('#parsedDataBody td');
    cells.forEach(cell => {
      cell.contentEditable = true;
      cell.classList.add('editable');
    });
    
    // Add a new row button to the parsed data table
    const parsedDataContainer = document.querySelector('.parsed-data-container');
    if (!document.getElementById('addParsedRow')) {
      const addRowBtn = document.createElement('button');
      addRowBtn.id = 'addParsedRow';
      addRowBtn.className = 'btn success-btn';
      addRowBtn.innerHTML = '<i class="fas fa-plus"></i> Add Row';
      addRowBtn.style.margin = '10px 0';
      
      addRowBtn.addEventListener('click', function() {
        const tbody = document.getElementById('parsedDataBody');
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-service', '');
        newRow.innerHTML = `
          <td contenteditable="true" class="editable"></td>
          <td contenteditable="true" class="editable"></td>
          <td contenteditable="true" class="editable"></td>
          <td contenteditable="true" class="editable"></td>
        `;
        tbody.appendChild(newRow);
      });
      
      parsedDataContainer.insertBefore(addRowBtn, parsedDataContainer.firstChild);
    }
  });
  
  // Save changes from the parsed data table to the main table
  saveDataBtn.addEventListener('click', function() {
    isEditing = false;
    editDataBtn.style.display = 'inline-flex';
    saveDataBtn.style.display = 'none';
    
    // Remove the editable state from all cells
    const cells = document.querySelectorAll('#parsedDataBody td');
    cells.forEach(cell => {
      cell.contentEditable = false;
      cell.classList.remove('editable');
    });
    
    // Remove the add row button
    const addRowBtn = document.getElementById('addParsedRow');
    if (addRowBtn) {
      addRowBtn.parentNode.removeChild(addRowBtn);
    }
    
    // Collect data from the parsed table to send to the server
    const parsedRows = document.querySelectorAll('#parsedDataBody tr');
    const services = [];
    
    parsedRows.forEach(row => {
      if (row.cells[0].textContent.trim() === '') return; // Skip empty rows
      
      const serviceName = row.cells[0].textContent;
      const date = row.cells[1].textContent;
      
      // Parse time range (e.g., "09:00 - 11:00" to start and end times)
      let startTime = '';
      let endTime = '';
      const timeRange = row.cells[2].textContent;
      
      if (timeRange.includes('-')) {
        const timeParts = timeRange.split('-');
        startTime = timeParts[0].trim();
        endTime = timeParts[1].trim();
      } else {
        startTime = timeRange;
      }
      
      const comments = row.cells[3].textContent;
      
      // Add this service to our array
      services.push({
        name: serviceName,
        start_time: startTime,
        end_time: endTime,
        end_date: date,
        comments: comments,
        priority: 'low'  // Default priority
      });
    });
    
    // Send data to server for persistence
    fetch('/save-parsed-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        services: services,
        date: document.querySelector('#parsedDataBody tr td:nth-child(2)').textContent // Use the date from first row
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Update the main table with the edited data
        updateMainTableFromParsedData();
      } else {
        alert('Error saving data: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error saving data. Please try again.');
    });
  });

  // Function to update the main table with data from the parsed data table
  function updateMainTableFromParsedData() {
    const parsedRows = document.querySelectorAll('#parsedDataBody tr');
    const mainTableBody = document.querySelector('#changeTable tbody');
    
    // Clear the main table
    mainTableBody.innerHTML = '';
    
    // Add rows from the parsed data table to the main table
    parsedRows.forEach(parsedRow => {
      if (parsedRow.cells[0].textContent.trim() === '') return; // Skip empty rows
      
      const serviceName = parsedRow.cells[0].textContent;
      const date = parsedRow.cells[1].textContent;
      
      // Parse time range (e.g., "09:00 - 11:00" to start and end times)
      let startTime = '';
      let endTime = '';
      const timeRange = parsedRow.cells[2].textContent;
      
      if (timeRange.includes('-')) {
        const timeParts = timeRange.split('-');
        startTime = timeParts[0].trim();
        endTime = timeParts[1].trim();
      } else {
        startTime = timeRange;
      }
      
      const comments = parsedRow.cells[3].textContent;
      
      // Create a new row for the main table
      const newRow = document.createElement('tr');
      newRow.setAttribute('data-priority', 'low'); // Default priority
      
      newRow.innerHTML = `
        <td>${serviceName}</td>
        <td>${date}</td>
        <td data-original="${startTime}">${startTime}</td>
        <td data-original="${endTime}">${endTime}</td>
        <td>${date}</td>
        <td>${comments}</td>
        <td class="impact-cell">
          <div class="impact-selector" data-value="low">
            <div class="impact-selector-inner">
              <div class="impact-option impact-option-low selected" data-value="low">
                <span class="impact-dot"></span> Low
              </div>
              <div class="impact-option impact-option-medium" data-value="medium">
                <span class="impact-dot"></span> Medium
              </div>
              <div class="impact-option impact-option-high" data-value="high">
                <span class="impact-dot"></span> High
              </div>
            </div>
          </div>
        </td>
        <td class="action-cell">
          <button class="table-btn edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="table-btn save-btn" style="display: none;" title="Save"><i class="fas fa-save"></i></button>
          <button class="table-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
        </td>
      `;
      
      mainTableBody.appendChild(newRow);
      initImpactSelector(newRow);
    });
    
    // If timezone toggle is checked, convert times to IST
    if (document.getElementById('tzToggle').checked) {
      document.getElementById('tzToggle').dispatchEvent(new Event('change'));
    }
    
    // Apply active filter
    applyActiveFilter();
    
    // Check if table is empty
    checkEmptyTable();
    
    // Show a success message
    alert('Changes saved successfully!');
  }
  
  // When a row in the parsed data table is clicked in edit mode
  document.querySelector('.parsed-data-table').addEventListener('click', function(e) {
    if (!isEditing) return;
    
    const cell = e.target.closest('td');
    if (cell) {
      // Add delete button if it doesn't exist
      const row = cell.parentNode;
      if (!row.querySelector('.delete-parsed-row')) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-parsed-row';
        deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
        deleteBtn.style.position = 'absolute';
        deleteBtn.style.right = '-25px';
        deleteBtn.style.top = '50%';
        deleteBtn.style.transform = 'translateY(-50%)';
        deleteBtn.style.background = 'var(--danger-color)';
        deleteBtn.style.color = 'white';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '50%';
        deleteBtn.style.width = '20px';
        deleteBtn.style.height = '20px';
        deleteBtn.style.display = 'flex';
        deleteBtn.style.alignItems = 'center';
        deleteBtn.style.justifyContent = 'center';
        deleteBtn.style.cursor = 'pointer';
        
        deleteBtn.addEventListener('click', function() {
          if (confirm('Delete this row?')) {
            row.remove();
          }
        });
        
        row.style.position = 'relative';
        row.appendChild(deleteBtn);
      }
    }
  });
  
  let isHighlighted = false;
  
  // Toggle between side-by-side and stacked layout
  toggleLayoutBtn.addEventListener('click', function() {
    const modalContent = document.querySelector('.modal-content');
    modalContent.classList.toggle('layout-stacked');
  });
  
  // Highlight data in the email content
  highlightDataBtn.addEventListener('click', function() {
    isHighlighted = !isHighlighted;
    
    if (isHighlighted) {
      highlightDataBtn.classList.add('active');
      highlightEmailContent();
    } else {
      highlightDataBtn.classList.remove('active');
      resetEmailHighlights();
    }
  });
  
  // Search functionality
  searchBtn.addEventListener('click', performSearch);
  emailSearch.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      performSearch();
    }
  });
  
  // Row highlighting when hovering over parsed data
  parsedDataRows.forEach(row => {
    row.addEventListener('mouseenter', function() {
      const serviceName = this.getAttribute('data-service');
      highlightServiceInEmail(serviceName);
      this.classList.add('highlight-row');
    });
    
    row.addEventListener('mouseleave', function() {
      if (!isHighlighted) {
        resetEmailHighlights();
      }
      this.classList.remove('highlight-row');
    });
  });
  
  function highlightEmailContent() {
    let emailContent = emailBody.innerHTML;
    
    // Extract data from table
    const services = Array.from(parsedDataRows).map(row => {
      return {
        name: row.cells[0].textContent,
        date: row.cells[1].textContent,
        time: row.cells[2].textContent
      };
    });
    
    // First, escape the content to prevent HTML injection
    emailContent = escapeHtml(emailBody.textContent);
    
    // Highlight dates
    const datePattern = /\b\d{1,4}[-/.]\d{1,2}[-/.]\d{1,4}\b/g;
    emailContent = emailContent.replace(datePattern, '<span class="highlight-date">$&</span>');
    
    // Highlight times
    const timePattern = /\b([0-1]?[0-9]|2[0-3])[:][0-5][0-9](\s*-\s*([0-1]?[0-9]|2[0-3])[:][0-5][0-9])?\b/g;
    emailContent = emailContent.replace(timePattern, '<span class="highlight-time">$&</span>');
    
    // Highlight service names
    services.forEach(service => {
      if (service.name.trim()) {
        const nameRegex = new RegExp('\\b' + escapeRegExp(service.name.trim()) + '\\b', 'gi');
        emailContent = emailContent.replace(nameRegex, '<span class="highlight-service">$&</span>');
      }
    });
    
    emailBody.innerHTML = emailContent;
  }
  
  function resetEmailHighlights() {
    emailBody.innerHTML = escapeHtml(emailBody.textContent);
  }
  
  function highlightServiceInEmail(serviceName) {
    if (!serviceName.trim()) return;
    
    let content = emailBody.textContent;
    const nameRegex = new RegExp('\\b' + escapeRegExp(serviceName.trim()) + '\\b', 'gi');
    
    if (content.match(nameRegex)) {
      content = escapeHtml(content);
      content = content.replace(nameRegex, '<span class="highlight-match">$&</span>');
      emailBody.innerHTML = content;
      
      // Scroll to the first match
      const firstMatch = emailBody.querySelector('.highlight-match');
      if (firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }
  
  function performSearch() {
    const searchTerm = emailSearch.value.trim();
    if (!searchTerm) return;
    
    let content = emailBody.textContent;
    const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
    const matches = content.match(regex);
    
    if (matches && matches.length > 0) {
      searchResults.textContent = `${matches.length} matches found`;
      
      content = escapeHtml(content);
      content = content.replace(regex, '<span class="highlight-match">$&</span>');
      emailBody.innerHTML = content;
      
      // Scroll to the first match
      const firstMatch = emailBody.querySelector('.highlight-match');
      if (firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    } else {
      searchResults.textContent = 'No matches found';
    }
  }
  
  // Helper functions
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
  
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
});

// ...existing code...

// Save changes from the parsed data table to the main table
  saveDataBtn.addEventListener('click', function() {
    isEditing = false;
    editDataBtn.style.display = 'inline-flex';
    saveDataBtn.style.display = 'none';
    
    // Remove the editable state from all cells
    const cells = document.querySelectorAll('#parsedDataBody td');
    cells.forEach(cell => {
      cell.contentEditable = false;
      cell.classList.remove('editable');
    });
    
    // Remove the add row button
    const addRowBtn = document.getElementById('addParsedRow');
    if (addRowBtn) {
      addRowBtn.parentNode.removeChild(addRowBtn);
    }
    
    // Collect data from the parsed table to send to the server
    const parsedRows = document.querySelectorAll('#parsedDataBody tr');
    const services = [];
    
    parsedRows.forEach(row => {
      if (row.cells[0].textContent.trim() === '') return; // Skip empty rows
      
      const serviceName = row.cells[0].textContent;
      const date = row.cells[1].textContent;
      
      // Parse time range (e.g., "09:00 - 11:00" to start and end times)
      let startTime = '';
      let endTime = '';
      const timeRange = row.cells[2].textContent;
      
      if (timeRange.includes('-')) {
        const timeParts = timeRange.split('-');
        startTime = timeParts[0].trim();
        endTime = timeParts[1].trim();
      } else {
        startTime = timeRange;
      }
      
      const comments = row.cells[3].textContent;
      
      // Add this service to our array
      services.push({
        name: serviceName,
        start_time: startTime,
        end_time: endTime,
        end_date: date,
        comments: comments,
        priority: 'low'  // Default priority
      });
    });
    
    // Send data to server for persistence
    fetch('/save-parsed-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        services: services,
        date: document.querySelector('#parsedDataBody tr td:nth-child(2)').textContent // Use the date from first row
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Update the main table with the edited data
        updateMainTableFromParsedData();
      } else {
        alert('Error saving data: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error saving data. Please try again.');
    });
  });

// ...existing code...

// Update the reset form handler to call the reset API
document.getElementById('resetForm').addEventListener('click', function() {
  if (confirm('Are you sure you want to reset the form? This will clear all data.')) {
    fetch('/reset-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      window.location.href = '/';
    })
    .catch(error => {
      console.error('Error:', error);
      window.location.href = '/';
    });
  }
});

// Add this function to gather all data from the table and save it to Redis
function syncAllDataToRedis() {
    const tableRows = document.querySelectorAll('#changeTable tbody tr:not(.empty-state)');
    const services = [];
    
    // If there are no rows, don't proceed
    if (tableRows.length === 0) {
        alert('No data to sync.');
        return;
    }
    
    // Gather data from all rows
    tableRows.forEach(row => {
        const cells = row.cells;
        if (cells.length < 7) return;
        
        const serviceName = cells[0].textContent;
        const date = cells[1].textContent;
        const startTime = cells[2].dataset.original || cells[2].textContent;
        const endTime = cells[3].dataset.original || cells[3].textContent;
        const endDate = cells[4].textContent;
        const comments = cells[5].textContent;
        const priority = row.getAttribute('data-priority') || 'low';
        
        services.push({
            name: serviceName,
            start_time: startTime,
            end_time: endTime,
            end_date: endDate || date,
            comments: comments,
            priority: priority
        });
    });
    
    // Get the current header title
    const headerTitle = document.getElementById('headerTitle').textContent;
    
    // Get the original email body if available
    const emailBody = document.getElementById('emailBody');
    const originalBody = emailBody ? emailBody.textContent : '';
    
    // Create the data object
    const data = {
        services: services,
        date: services.length > 0 ? services[0].end_date : new Date().toISOString().split('T')[0],
        header_title: headerTitle,
        original_body: originalBody
    };
    
    // Show loading animation
    const loadingEl = document.createElement('div');
    loadingEl.className = 'sync-loading';
    loadingEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing data...';
    loadingEl.style = 'position:fixed; top:20px; right:20px; background:var(--primary-color); color:white; padding:10px 15px; border-radius:4px; z-index:10000;';
    document.body.appendChild(loadingEl);
    
    // Send to server
    fetch('/sync-all-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        document.body.removeChild(loadingEl);
        if (result.status === 'success') {
            const successEl = document.createElement('div');
            successEl.className = 'sync-success';
            successEl.innerHTML = '<i class="fas fa-check-circle"></i> Data synced successfully!';
            successEl.style = 'position:fixed; top:20px; right:20px; background:var(--success-color); color:white; padding:10px 15px; border-radius:4px; z-index:10000;';
            document.body.appendChild(successEl);
            setTimeout(() => {
                document.body.removeChild(successEl);
            }, 3000);
        } else {
            alert('Error syncing data: ' + (result.message || 'Unknown error'));
        }
    })
    .catch(error => {
        document.body.removeChild(loadingEl);
        console.error('Error:', error);
        alert('Error syncing data. Please try again.');
    });
}

// Add event listener for the sync button
document.addEventListener('DOMContentLoaded', function() {
    const syncBtn = document.getElementById('syncData');
    if (syncBtn) {
        syncBtn.addEventListener('click', syncAllDataToRedis);
    }
    
    // Enhance the row save functionality to ensure data is saved to Redis
    document.querySelector('table').addEventListener('click', function(e) {
        if (e.target.closest('.save-btn')) {
            const row = e.target.closest('tr');
            const cells = row.getElementsByTagName('td');
            
            // Update original data attributes for time cells
            const startTimeCell = cells[2];
            const endTimeCell = cells[3];
            
            startTimeCell.dataset.original = startTimeCell.textContent;
            endTimeCell.dataset.original = endTimeCell.textContent;

            // Make cells not editable
            for (let i = 0; i < cells.length - 1; i++) {
                cells[i].contentEditable = false;
                cells[i].classList.remove('editable');
            }
            
            // Update UI
            row.querySelector('.save-btn').style.display = 'none';
            row.querySelector('.edit-btn').style.display = 'inline-flex';
            
            applyRowHighlight(row);
            
            // Get all data needed for saving
            const rowData = {
                service: cells[0].textContent,
                date: cells[1].textContent,
                startTime: cells[2].textContent,
                endTime: cells[3].textContent,
                endDate: cells[4].textContent,
                comments: cells[5].textContent,
                impactPriority: row.querySelector('.impact-selector').getAttribute('data-value')
            };
            
            // Send to server
            fetch('/save-changes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Error saving row:', data.message);
                    alert('Error saving data. You may need to refresh the page and try again.');
                }
            })
            .catch(error => {
                console.error('Error saving row:', error);
                alert('Network error while saving. Please try again.');
            });
        }
    });
    
    // Enhanced impact selector to save changes immediately
    document.querySelectorAll('.impact-option').forEach(option => {
        option.addEventListener('click', function() {
            const tr = this.closest('tr');
            if (!tr) return;
            
            const priority = this.getAttribute('data-value');
            const selector = tr.querySelector('.impact-selector');
            const cells = tr.cells;
            
            // After priority is set, save the change to Redis
            const rowData = {
                service: cells[0].textContent,
                date: cells[1].textContent,
                startTime: cells[2].dataset.original || cells[2].textContent,
                endTime: cells[3].dataset.original || cells[3].textContent,
                endDate: cells[4].textContent,
                comments: cells[5].textContent,
                impactPriority: priority
            };
            
            fetch('/save-changes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowData)
            })
            .catch(error => console.error('Error saving priority change:', error));
        });
    });
});

// Enhanced function for adding a new row to save it immediately
document.getElementById('addRow').addEventListener('click', function() {
    const tbody = document.querySelector('tbody');
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-priority', 'low');
    
    const emptyState = tbody.querySelector('.empty-state');
    if (emptyState) {
        tbody.removeChild(emptyState);
    }
    
    const todayDate = new Date().toISOString().split('T')[0];
    
    newRow.innerHTML = `
    <td contenteditable="true" class="editable"></td>
    <td contenteditable="true" class="editable">${todayDate}</td>
    <td contenteditable="true" class="editable"></td>
    <td contenteditable="true" class="editable"></td>
    <td contenteditable="true" class="editable">${todayDate}</td>
    <td contenteditable="true" class="editable"></td>
    <td class="impact-cell">
        <div class="impact-selector" data-value="low">
        <div class="impact-selector-inner">
            <div class="impact-option impact-option-low selected" data-value="low">
            <span class="impact-dot"></span> Low
            </div>
            <div class="impact-option impact-option-medium" data-value="medium">
            <span class="impact-dot"></span> Medium
            </div>
            <div class="impact-option impact-option-high" data-value="high">
            <span class="impact-dot"></span> High
            </div>
        </div>
        </div>
    </td>
    <td class="action-cell">
        <button class="table-btn edit-btn" title="Edit" style="display: none;"><i class="fas fa-edit"></i></button>
        <button class="table-btn save-btn" title="Save" style="display: inline-flex;"><i class="fas fa-save"></i></button>
        <button class="table-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
    </td>
    `;
    tbody.appendChild(newRow);
    
    applyRowHighlight(newRow);
    initImpactSelector(newRow);
    applyActiveFilter();
    
    // Auto-save this empty row to Redis so it's preserved
    const rowData = {
        service: '',
        date: todayDate,
        startTime: '',
        endTime: '',
        endDate: todayDate,
        comments: '',
        impactPriority: 'low'
    };
    
    fetch('/save-changes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(rowData)
    }).catch(error => console.error('Error saving new row:', error));
});

// ...existing code...

// Replace the existing resetForm event listener with this improved version
// Make sure this code appears ONLY ONCE in the file
document.addEventListener('DOMContentLoaded', function() {
    const resetFormBtn = document.getElementById('resetForm');
    
    // Remove any existing event listeners by cloning and replacing the button
    const newResetBtn = resetFormBtn.cloneNode(true);
    resetFormBtn.parentNode.replaceChild(newResetBtn, resetFormBtn);
    
    // Add a single event listener to the new button
    newResetBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (confirm('Are you sure you want to reset the form? This will clear all data.')) {
            // Show loading indicator
            const loadingEl = document.createElement('div');
            loadingEl.className = 'sync-loading';
            loadingEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting data...';
            loadingEl.style = 'position:fixed; top:20px; right:20px; background:var(--primary-color); color:white; padding:10px 15px; border-radius:4px; z-index:10000;';
            document.body.appendChild(loadingEl);
            
            fetch('/reset-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                // Force a complete refresh with no caching
                const reloadUrl = window.location.href.split('?')[0] + 
                                '?nocache=' + new Date().getTime();
                window.location.replace(reloadUrl);
            })
            .catch(error => {
                console.error('Error:', error);
                document.body.removeChild(loadingEl);
                alert('Error resetting data. Please try again.');
            });
        }
    });
    
    // Remove any other event listeners that might be registered elsewhere
    const oldHandlers = getEventListeners || (el => ({}));
    const existingResetHandlers = oldHandlers(document.getElementById('resetForm')) || {};
    if (existingResetHandlers.click) {
        existingResetHandlers.click.forEach(handler => {
            if (handler !== newResetBtn.onclick) {
                document.getElementById('resetForm').removeEventListener('click', handler);
            }
        });
    }
});

// ...existing code...

// Replace the syncAllDataToRedis function with this improved version
function syncAllDataToRedis() {
    const tableRows = document.querySelectorAll('#changeTable tbody tr:not(.empty-state)');
    const services = [];
    
    // If there are no rows, don't proceed
    if (tableRows.length === 0) {
        alert('No data to sync.');
        return;
    }
    
    // Gather data from all rows
    tableRows.forEach(row => {
        const cells = row.cells;
        if (cells.length < 7) return;
        
        const serviceName = cells[0].textContent;
        const date = cells[1].textContent;
        const startTime = cells[2].dataset.original || cells[2].textContent;
        const endTime = cells[3].dataset.original || cells[3].textContent;
        const endDate = cells[4].textContent;
        const comments = cells[5].textContent;
        const priority = row.getAttribute('data-priority') || 'low';
        
        services.push({
            name: serviceName,
            start_time: startTime,
            end_time: endTime,
            end_date: endDate || date,
            comments: comments,
            priority: priority
        });
    });
    
    // Get the current header title
    const headerTitle = document.getElementById('headerTitle').textContent;
    
    // Get the original email body if available
    const emailBody = document.getElementById('emailBody');
    const originalBody = emailBody ? emailBody.textContent : '';
    
    // Create the data object
    const data = {
        services: services,
        date: services.length > 0 ? services[0].end_date : new Date().toISOString().split('T')[0],
        header_title: headerTitle,
        original_body: originalBody
    };
    
    // Show loading animation
    const loadingEl = document.createElement('div');
    loadingEl.className = 'sync-loading';
    loadingEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing data...';
    loadingEl.style = 'position:fixed; top:20px; right:20px; background:var(--primary-color); color:white; padding:10px 15px; border-radius:4px; z-index:10000;';
    document.body.appendChild(loadingEl);
    
    // Disable any unsaved changes warnings
    window.onbeforeunload = null;
    
    // Send to server
    fetch('/sync-all-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
        cache: 'no-store'
    })
    .then(response => response.json())
    .then(result => {
        document.body.removeChild(loadingEl);
        if (result.status === 'success') {
            // Update the timestamp
            document.getElementById('dataTimestamp').value = result.timestamp;
            
            const successEl = document.createElement('div');
            successEl.className = 'sync-success';
            successEl.innerHTML = '<i class="fas fa-check-circle"></i> Data synced successfully!';
            successEl.style = 'position:fixed; top:20px; right:20px; background:var(--success-color); color:white; padding:10px 15px; border-radius:4px; z-index:10000;';
            document.body.appendChild(successEl);
            
            // Ask the user if they want to reload for a fresh state
            if (confirm('Data synced successfully! Reload page to ensure you have the latest data?')) {
                // Force a complete refresh with no caching
                const reloadUrl = window.location.href.split('?')[0] + '?nocache=' + new Date().getTime();
                window.location.replace(reloadUrl);
            } else {
                // Just remove the success message after a delay
                setTimeout(() => {
                    document.body.removeChild(successEl);
                }, 3000);
            }
        } else {
            alert('Error syncing data: ' + (result.message || 'Unknown error'));
        }
    })
    .catch(error => {
        document.body.removeChild(loadingEl);
        console.error('Error:', error);
        alert('Error syncing data. Please try again.');
    });
}

// Add a function to periodically check for updates from other tabs
function setupUpdateChecker() {
    const checkInterval = 10000; // Check every 10 seconds
    
    function checkForUpdates() {
        const currentTimestamp = document.getElementById('dataTimestamp').value;
        
        fetch(`/check-updates?since=${currentTimestamp}&_=${Date.now()}`, {
            method: 'GET',
            cache: 'no-store'
        })
        .then(response => response.json())
        .then(data => {
            if (data.updated) {
                // Show notification that data has been updated elsewhere
                const updateNotice = document.createElement('div');
                updateNotice.className = 'update-notice';
                updateNotice.innerHTML = '<i class="fas fa-info-circle"></i> Data has been updated. <a href="#" id="refreshPage">Refresh</a> to see the latest changes.';
                updateNotice.style = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--primary-color); color:white; padding:10px 15px; border-radius:4px; z-index:10000; text-align:center;';
                document.body.appendChild(updateNotice);
                
                // When the refresh link is clicked
                document.getElementById('refreshPage').addEventListener('click', function(e) {
                    e.preventDefault();
                    // Force a complete refresh with no caching
                    const reloadUrl = window.location.href.split('?')[0] + '?nocache=' + Date.now();
                    window.location.replace(reloadUrl);
                });
            }
        })
        .catch(error => console.error('Error checking for updates:', error));
    }
    
    // Start periodic checking
    setInterval(checkForUpdates, checkInterval);
}

// Initialize update checker on page load
document.addEventListener('DOMContentLoaded', function() {
    // ...existing initialization code...
    
    setupUpdateChecker();
    
    // Add this to prevent the "confirm form resubmission" dialog
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }
});

// ...existing code...

// Make sure our page starts fresh by adding cache control meta tags
</script>

<!-- Add these meta tags in the <head> section to prevent caching -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- ...existing code... -->
<!-- Add this hidden input to track data timestamp -->
<input type="hidden" id="dataTimestamp" value="{{ data_timestamp|default(0) }}">
</body>
</html>